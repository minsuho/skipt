---

**용어 및 가정:**

*   **업데이트 주기:** 정해진 시간 간격 (예: 매 10분)
*   **주식 코드 (`주식코드`):** 각 주식을 식별하는 고유 코드 (예: "사과주식")
*   **슬리피지(Slippage):** 대량 주문 시 유동성 부족으로 인해 실제 체결 가격이 현재 시장 가격보다 불리하게 형성되는 현상.

---

**사전 정의 변수 (주식별, 주기 시작 시 또는 초기 설정 시 고정):**

*   `현재_기준_시장_가격[`주식코드`]`: **이번 업데이트 주기 동안 사용될 기준 시장 가격.** 이전 주기 마지막에 결정된 가격이며, 이번 주기 내 플레이어 거래 시 슬리피지 계산의 기준이 됩니다. 이 값은 다음 주기 업데이트 전까지 변하지 않습니다.
*   `가격_계산_기준_주식_수[`주식코드`]`: (이전의 `total_shares` 또는 `실제_유통_주식_수` 개념) 해당 주식의 규모를 나타내는 값. 슬리피지 및 주기적 가격 변동폭 계산 시 "이 정도 거래량이면 크다/작다"를 판단하는 기준이 됩니다. (실제 유통량이나 플레이어간 거래 가능 물량과는 다름. 서버는 무한 유동성 공급 가정)
*   `초기_상장가[`주식코드`]`: 해당 주식이 처음 상장되었을 때의 가격.
*   `단기_이평선_가격[`주식코드`]`: 최근 N1주기 (예: 5주기) 동안의 `새로운_기준_시장_가격`의 평균.
*   `장기_이평선_가격[`주식코드`]`: 최근 N2주기 (예: 20주기) 동안의 `새로운_기준_시장_가격`의 평균.

**주기 동안 누적되는 변수 (주식별, 주기 업데이트 시 초기화):**

*   `이번_주기_총매수_주식수[`주식코드`]`: 이번 주기 동안 플레이어들이 해당 주식을 매수한 총 주식 수.
*   `이번_주기_총매도_주식수[`주식코드`]`: 이번 주기 동안 플레이어들이 해당 주식을 매도한 총 주식 수.

**조절 가능한 파라미터 (시스템 전체 또는 주식별 설정 가능):**

*   `슬리피지_유동성_영향계수 = 0.1` (이 값이 작을수록 적은 거래량에도 슬리피지가 크게 발생)
*   `슬리피지_가격_민감도 = 0.5` (슬리피지가 가격에 얼마나 민감하게 영향을 줄지)
*   `최소거래량_반영_비율 = 0.0005`
*   `기본_수요_가격_민감도 = 0.025`
*   `대량거래_판단_비율 = 0.02` ( `가격_계산_기준_주식_수` 대비)
*   `대량거래_추가_가격_민감도 = 0.75`
*   `대량거래_가중치_최대배율 = 2.5`
*   `시장심리_가격_민감도 = 0.15`
*   `최대_기본_무작위_변동률 = 0.002`
*   `주기당_최대_가격_변동률_제한 = 0.10` (±10%)
*   `상장폐지_기준_가격_비율 = 0.10` (초기 상장가 대비)
*   `상장폐지_경고_지속_주기수 = 4`

---

**I. 플레이어의 주식 매수/매도 시점 (실시간 처리)**

**(A) 매수 시 (`/주식매수 <주식코드> <구매요청수량>`)**

1.  **슬리피지 계산:**
    *   `구매_주문_영향력 = 구매요청수량 / (가격_계산_기준_주식_수[주식코드] * 슬리피지_유동성_영향계수)`
    *   `매수_슬리피지_적용_비율 = 구매_주문_영향력 * 슬리피지_가격_민감도`
2.  **실제 체결 단가 결정:**
    *   `매수_실제_체결_단가 = 현재_기준_시장_가격[주식코드] * (1 + 매수_슬리피지_적용_비율)`
3.  **총 거래 비용 및 처리:**
    *   `총_매수_비용 = 매수_실제_체결_단가 * 구매요청수량` (+ 선택적 수수료)
    *   플레이어 돈 차감, 주식 지급.
    *   `이번_주기_총매수_주식수[주식코드]`에 `구매요청수량` 더하기.
    *   플레이어에게 실제 체결 단가 및 슬리피지 정보 알림.

**(B) 매도 시 (`/주식매도 <주식코드> <판매요청수량>`)**

1.  **슬리피지 계산:**
    *   `판매_주문_영향력 = 판매요청수량 / (가격_계산_기준_주식_수[주식코드] * 슬리피지_유동성_영향계수)`
    *   `매도_슬리피지_적용_비율 = 판매_주문_영향력 * 슬리피지_가격_민감도`
2.  **실제 체결 단가 결정:**
    *   `매도_실제_체결_단가 = 현재_기준_시장_가격[주식코드] * (1 - 매도_슬리피지_적용_비율)`
3.  **총 수령 금액 및 처리:**
    *   `총_매도_수익 = 매도_실제_체결_단가 * 판매요청수량` (- 선택적 수수료)
    *   플레이어 주식 차감, 돈 지급.
    *   `이번_주기_총매도_주식수[주식코드]`에 `판매요청수량` 더하기.
    *   플레이어에게 실제 체결 단가 및 슬리피지 정보 알림.

---

**II. 주기적 업데이트 시점 (예: 매 10분마다 각 `주식코드`에 대해 실행)**

**(A) 1단계: 플레이어 수요공급 영향 계산**

1.  `이번_주기_순매수_주식수 = 이번_주기_총매수_주식수[주식코드] - 이번_주기_총매도_주식수[주식코드]`
2.  `이번_주기_전체_거래_주식수 = 이번_주기_총매수_주식수[주식코드] + 이번_주기_총매도_주식수[주식코드]`
3.  `최소거래량_보정값 = max(1, 가격_계산_기준_주식_수[주식코드] * 최소거래량_반영_비율)`
4.  `수요공급_압력_비율 = 0`
    `if 이번_주기_전체_거래_주식수 > 0 then 수요공급_압력_비율 = 이번_주기_순매수_주식수 / (이번_주기_전체_거래_주식수 + 최소거래량_보정값)`
5.  `기본_수요_가격_변동률 = 수요공급_압력_비율 * 기본_수요_가격_민감도`
6.  `이번_주기_순매수_절대값 = abs(이번_주기_순매수_주식수)`
7.  `대량거래_판단_기준_주식수 = 가격_계산_기준_주식_수[주식코드] * 대량거래_판단_비율`
8.  `대량거래_영향_가중치 = 1`
    `if 이번_주기_순매수_절대값 > 대량거래_판단_기준_주식수 then`
        `초과분_비율 = (이번_주기_순매수_절대값 - 대량거래_판단_기준_주식수) / 대량거래_판단_기준_주식수`
        `대량거래_영향_가중치 = 1 + (초과분_비율 * 대량거래_추가_가격_민감도)`
        `대량거래_영향_가중치 = min(대량거래_영향_가중치, 대량거래_가중치_최대배율)`
9.  `최종_수요공급_기반_변동률 = 기본_수요_가격_변동률 * 대량거래_영향_가중치`

**(B) 2단계: 시장 심리/모멘텀 영향 계산**

1.  `이동평균선_괴리율 = 0`
    `if 장기_이평선_가격[주식코드] > 0 then 이동평균선_괴리율 = (단기_이평선_가격[주식코드] - 장기_이평선_가격[주식코드]) / 장기_이평선_가격[주식코드]`
2.  `시장심리_기반_변동률 = 이동평균선_괴리율 * 시장심리_가격_민감도`

**(C) 3단계: 최소 기본 무작위 변동성 계산**

1.  `무작위_요소 = random_real_number_between(-1, 1)`
2.  `기본_무작위_변동률 = 무작위_요소 * 최대_기본_무작위_변동률`

**(D) 4단계: 총합 변동률 계산 및 새로운 `현재_기준_시장_가격` 결정**

1.  `이번_주기_총_가격_변동률 = 최종_수요공급_기반_변동률 + 시장심리_기반_변동률 + 기본_무작위_변동률`
2.  `이번_주기_총_가격_변동률 = max(-주기당_최대_가격_변동률_제한, min(주기당_최대_가격_변동률_제한, 이번_주기_총_가격_변동률))` (상하한 적용)
3.  `새로운_기준_시장_가격 = 현재_기준_시장_가격[주식코드] * (1 + 이번_주기_총_가격_변동률)`
4.  `새로운_기준_시장_가격 = max(0.01, 새로운_기준_시장_가격)` (최소 0.01 G 보장)

**(E) 5단계: 주기적 데이터 초기화, 히스토리 기록, `현재_기준_시장_가격` 업데이트**

1.  `이번_주기_총매수_주식수[주식코드] = 0`
2.  `이번_주기_총매도_주식수[주식코드] = 0`
3.  **`현재_기준_시장_가격[주식코드]`를 방금 계산한 `새로운_기준_시장_가격`으로 업데이트.** (이것이 다음 주기의 거래 및 계산 기준이 됩니다.)
4.  `새로운_기준_시장_가격`과 `이번_주기_전체_거래_주식수`를 해당 시간의 히스토리로 기록. (이 히스토리를 바탕으로 다음 `단기_이평선_가격`과 `장기_이평선_가격`이 계산됩니다.)

**(F) 6단계: 상장 폐지 조건 확인**

1.  `상장폐지_기준_가격 = 초기_상장가[주식코드] * 상장폐지_기준_가격_비율`
2.  `if 새로운_기준_시장_가격 <= 상장폐지_기준_가격 then`
        `{주식코드}_상장폐지_경고_카운트`를 1 증가.
        `if {주식코드}_상장폐지_경고_카운트 >= 상장폐지_경고_지속_주기수 then`
            `해당_주식_상장_폐지_처리_실행(주식코드)`
    `else`
        `{주식코드}_상장폐지_경고_카운트 = 0`

---
